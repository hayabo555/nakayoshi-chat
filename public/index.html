<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ä»²è‰¯ã—CHAT ğŸŒ¸</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <div id="page-login" class="page active">
        <div class="login-card">
            <i class="fa-solid fa-face-kiss-wink-heart"></i>
            <h2>ä»²è‰¯ã—CHAT</h2>
            <input type="text" id="username" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="10">
            <button onclick="login()">ã¯ã˜ã‚ã‚‹</button>
        </div>
    </div>

    <div id="page-chat" class="page">
        <header>
            <div id="room-display" onclick="handleAdminClick()">
                <i class="fa-solid fa-heart"></i> <span id="current-room-name">å…¨å“¡ãƒãƒ£ãƒƒãƒˆ</span>
            </div>
            <div id="admin-tools" style="display:none;">
                <button onclick="clearHistory()" class="admin-btn">å±¥æ­´å‰Šé™¤</button>
            </div>
            <div class="online-badge" onclick="showUsers()" style="cursor:pointer">
                <i class="fa-solid fa-users"></i> <span id="online-count">0</span> Online
            </div>
        </header>

        <div id="messages"></div>

        <div class="input-area">
            <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off">
            <button class="send-btn" onclick="sendMsg()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>

        <footer>
            <button class="active" onclick="changeRoom('å…¨å“¡ãƒãƒ£ãƒƒãƒˆ')"><i class="fa-solid fa-house"></i>å…¨å“¡</button>
            <button onclick="openCreateModal()"><i class="fa-solid fa-circle-plus"></i>ã‚°ãƒ«ãƒ¼ãƒ—</button>
            <button onclick="window.location.href='https://choco-tube-nana-01.onrender.com'"><i class="fa-brands fa-youtube" style="color:red"></i>Tube</button>
        </footer>
    </div>

    <div id="modal-group" class="modal">
        <div class="modal-content">
            <h3>éƒ¨å±‹ã‚’ä½œã‚‹</h3>
            <input type="text" id="new-room-name" placeholder="éƒ¨å±‹åã‚’å…¥åŠ›">
            <div class="modal-btns">
                <button onclick="closeModal('modal-group')" class="btn-close">æˆ»ã‚‹</button>
                <button onclick="confirmCreateGroup()" class="btn-create">ä½œæˆ</button>
            </div>
        </div>
    </div>

    <div id="modal-users" class="modal">
        <div class="modal-content">
            <h3>å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼</h3>
            <div id="user-list" style="margin: 15px 0; text-align: left; max-height: 200px; overflow-y: auto;"></div>
            <button onclick="closeModal('modal-users')" class="btn-close" style="width:100%">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        const socket = io();
        let myName = "";
        let currentRoom = "å…¨å“¡ãƒãƒ£ãƒƒãƒˆ";
        let clickCount = 0;
        let onlineNames = [];
        const sound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

        function login() {
            const user = document.getElementById('username').value.trim();
            if(!user) return alert("åå‰ã‚’æ•™ãˆã¦ã­ï¼");
            myName = user;
            socket.emit('login', myName);
            document.getElementById('page-login').classList.remove('active');
            document.getElementById('page-chat').classList.add('active');
            changeRoom('å…¨å“¡ãƒãƒ£ãƒƒãƒˆ');
        }

        function handleAdminClick() {
            clickCount++;
            if(clickCount >= 3) {
                const pass = prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
                if(pass === "0830") {
                    document.getElementById('admin-tools').style.display = 'block';
                    alert("ç®¡ç†è€…ãƒ„ãƒ¼ãƒ«é–‹æ”¾");
                }
                clickCount = 0;
            }
            setTimeout(() => clickCount = 0, 3000);
        }

        function clearHistory() {
            if(confirm("ã“ã®éƒ¨å±‹ã®å±¥æ­´ã‚’ã™ã¹ã¦æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
                socket.emit('admin-clear-history', { room: currentRoom, password: "0830" });
            }
        }

        function showUsers() {
            const list = document.getElementById('user-list');
            list.innerHTML = onlineNames.map(u => `<div style="padding:5px; border-bottom:1px solid #eee;">ğŸŒ¸ ${u}</div>`).join('');
            document.getElementById('modal-users').style.display = 'flex';
        }

        function changeRoom(name) {
            currentRoom = name;
            document.getElementById('current-room-name').innerText = name;
            document.getElementById('messages').innerHTML = "";
            socket.emit('join-room', name);
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            if(!input.value.trim()) return;
            socket.emit('chat-message', { room: currentRoom, name: myName, text: input.value });
            input.value = "";
        }

        function addMessage(data) {
            const box = document.getElementById('messages');
            const isMe = data.name === myName;
            const div = document.createElement('div');
            const isOmikuji = data.type === 'omikuji';
            div.className = `msg-bubble ${isMe ? 'my-msg' : 'other-msg'} ${isOmikuji ? 'omikuji-msg' : ''}`;
            div.innerHTML = `
                ${isMe ? '' : '<div class="user-name">'+data.name+'</div>'}
                <div class="text">${data.text}</div>
                <div class="msg-time">${data.time}</div>
            `;
            box.appendChild(div);
            box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
        }

        socket.on('load-history', (history) => history.forEach(addMessage));
        socket.on('chat-message', (data) => {
            addMessage(data);
            if(data.name !== myName) sound.play().catch(()=>{});
        });
        socket.on('update-online-users', (users) => {
            onlineNames = users;
            document.getElementById('online-count').innerText = users.length;
        });

        function openCreateModal() { document.getElementById('modal-group').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function confirmCreateGroup() {
            const name = document.getElementById('new-room-name').value.trim();
            if(name) { changeRoom(name); closeModal('modal-group'); }
        }

        document.getElementById('msg-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMsg(); });
    </script>
</body>
</html>