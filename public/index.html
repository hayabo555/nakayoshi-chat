<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ä»²è‰¯ã—CHAT ğŸŒ¸</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <div id="page-login" class="page active">
        <div class="login-card">
            <i class="fa-solid fa-heart-pulse"></i>
            <h2>ä»²è‰¯ã—CHAT</h2>
            <input type="text" id="username" placeholder="åå‰ã‚’å…¥åŠ›">
            <button onclick="login()">ã¯ã˜ã‚ã‚‹</button>
        </div>
    </div>

    <div id="page-chat" class="page">
        <header>
            <div id="room-display" onclick="createGroup()" style="cursor:pointer">
                <i class="fa-solid fa-comments"></i> <span id="current-room-name">å…¨å“¡ãƒãƒ£ãƒƒãƒˆ</span> â–¾
            </div>
            <div class="online-badge">
                <i class="fa-solid fa-circle"></i> <span id="online-count">0</span> Online
            </div>
        </header>

        <div id="messages"></div>

        <div class="input-area">
            <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
            <button class="send-btn" onclick="sendMsg()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>

        <footer>
            <button class="active" onclick="location.reload()"><i class="fa-solid fa-house"></i>ãƒªã‚»ãƒƒãƒˆ</button>
            <button onclick="createGroup()"><i class="fa-solid fa-users-rectangle"></i>ã‚°ãƒ«ãƒ¼ãƒ—</button>
            <button onclick="window.location.href='https://choco-tube-nana-01.onrender.com'"><i class="fa-brands fa-youtube"></i>YouTube</button>
        </footer>
    </div>

    <script>
        const socket = io();
        let myName = "";
        let currentRoom = "å…¨å“¡ãƒãƒ£ãƒƒãƒˆ";
        const sound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

        function login() {
            const user = document.getElementById('username').value.trim();
            if(!user) return alert("åå‰ã‚’æ•™ãˆã¦ã­ï¼");
            myName = user;
            socket.emit('login', myName);
            document.getElementById('page-login').classList.remove('active');
            document.getElementById('page-chat').classList.add('active');
            changeRoom('å…¨å“¡ãƒãƒ£ãƒƒãƒˆ');
        }

        function changeRoom(name) {
            currentRoom = name;
            document.getElementById('current-room-name').innerText = name;
            document.getElementById('messages').innerHTML = "";
            socket.emit('join-room', name);
        }

        function createGroup() {
            const name = prompt("ã‚°ãƒ«ãƒ¼ãƒ—åã€ã¾ãŸã¯å€‹äººãƒãƒ£ãƒƒãƒˆã™ã‚‹ç›¸æ‰‹ã®åå‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼\nï¼ˆç›¸æ‰‹ã‚‚åŒã˜åå‰ã‚’å…¥ã‚Œã‚‹ã¨ç¹‹ãŒã‚‹ã‚ˆï¼‰");
            if(name) changeRoom(name);
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            if(!input.value.trim()) return;
            socket.emit('chat-message', { room: currentRoom, name: myName, text: input.value });
            input.value = "";
        }

        socket.on('load-history', (history) => history.forEach(addMessage));
        socket.on('chat-message', (data) => {
            addMessage(data);
            if(data.name !== myName) sound.play().catch(()=>{});
        });
        socket.on('update-online-count', (count) => document.getElementById('online-count').innerText = count);

        function addMessage(data) {
            const box = document.getElementById('messages');
            const isMe = data.name === myName;
            const div = document.createElement('div');
            div.className = `msg-bubble ${isMe ? 'my-msg' : 'other-msg'}`;
            div.innerHTML = `${isMe ? '' : '<div class="user-name">'+data.name+'</div>'}<div>${data.text}</div><div class="msg-time">${data.time}</div>`;
            box.appendChild(div);
            box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
        }

        document.getElementById('msg-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMsg(); });
    </script>
</body>
</html>