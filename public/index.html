<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ä»²è‰¯ã—CHAT Super ğŸŒ¸</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <div id="page-login" class="page active">
        <div class="login-card">
            <i class="fa-solid fa-face-smile-beam"></i>
            <h2>ä»²è‰¯ã—CHAT</h2>
            <input type="text" id="username" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " maxlength="10">
            <button onclick="login()">ã¯ã˜ã‚ã‚‹</button>
        </div>
    </div>

    <div id="page-chat" class="page">
        <header>
            <div id="room-display" onclick="handleAdminClick()">
                <i class="fa-solid fa-comments"></i> <span id="current-room-name">å…¨å“¡ãƒãƒ£ãƒƒãƒˆ</span>
            </div>
            <div id="admin-tools" style="display:none;">
                <button onclick="clearHistory()" class="admin-btn">å±¥æ­´å‰Šé™¤</button>
            </div>
            <div class="online-badge">
                <i class="fa-solid fa-circle"></i> <span id="online-count">0</span> Online
            </div>
        </header>

        <div id="messages"></div>

        <div class="input-area">
            <input type="text" id="msg-input" placeholder="/ãŠã¿ãã˜ ã‚‚å¼•ã‘ã‚‹ã‚ˆï¼" autocomplete="off">
            <button class="send-btn" onclick="sendMsg()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>

        <footer>
            <button class="active" onclick="changeRoom('å…¨å“¡ãƒãƒ£ãƒƒãƒˆ')"><i class="fa-solid fa-globe"></i>å…¨å“¡</button>
            <button onclick="openCreateModal()"><i class="fa-solid fa-users-plus"></i>ã‚°ãƒ«ãƒ¼ãƒ—</button>
            <button onclick="window.location.href='https://choco-tube-nana-01.onrender.com'"><i class="fa-brands fa-youtube"></i>YouTube</button>
        </footer>
    </div>

    <div id="modal-group" class="modal">
        <div class="modal-content">
            <h3>éƒ¨å±‹ã‚’ä½œã‚‹</h3>
            <input type="text" id="new-room-name" placeholder="éƒ¨å±‹åã‚’å…¥åŠ›">
            <div class="modal-btns">
                <button onclick="closeModal()" class="btn-close">æˆ»ã‚‹</button>
                <button onclick="confirmCreateGroup()" class="btn-create">ä½œæˆ</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let myName = "";
        let currentRoom = "å…¨å“¡ãƒãƒ£ãƒƒãƒˆ";
        let clickCount = 0;
        const sound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

        function login() {
            const user = document.getElementById('username').value.trim();
            if(!user) return;
            myName = user;
            socket.emit('login', myName);
            document.getElementById('page-login').classList.remove('active');
            document.getElementById('page-chat').classList.add('active');
            changeRoom('å…¨å“¡ãƒãƒ£ãƒƒãƒˆ');
        }

        function handleAdminClick() {
            clickCount++;
            if(clickCount >= 3) {
                const pass = prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
                if(pass === "0830") {
                    document.getElementById('admin-tools').style.display = 'block';
                    alert("ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ON");
                }
                clickCount = 0;
            }
            setTimeout(() => clickCount = 0, 3000);
        }

        function clearHistory() {
            if(confirm("ã“ã®éƒ¨å±‹ã®å±¥æ­´ã‚’ã™ã¹ã¦æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
                socket.emit('admin-clear-history', { room: currentRoom, password: "0830" });
            }
        }

        function changeRoom(name) {
            currentRoom = name;
            document.getElementById('current-room-name').innerText = name;
            document.getElementById('messages').innerHTML = "";
            socket.emit('join-room', name);
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            if(!input.value.trim()) return;
            socket.emit('chat-message', { room: currentRoom, name: myName, text: input.value });
            input.value = "";
        }

        socket.on('load-history', (history) => history.forEach(addMessage));
        socket.on('chat-message', (data) => {
            addMessage(data);
            if(data.name !== myName) sound.play().catch(()=>{});
        });
        socket.on('update-online-count', (count) => document.getElementById('online-count').innerText = count);

        function addMessage(data) {
            const box = document.getElementById('messages');
            const isMe = data.name === myName;
            const div = document.createElement('div');
            // ãŠã¿ãã˜ã®å ´åˆã¯ç‰¹åˆ¥ãªè‰²ã«ã™ã‚‹
            const isOmikuji = data.type === 'omikuji';
            div.className = `msg-bubble ${isMe ? 'my-msg' : 'other-msg'} ${isOmikuji ? 'omikuji-msg' : ''}`;
            div.innerHTML = `
                ${isMe ? '' : '<div class="user-name">'+data.name+'</div>'}
                <div class="text">${data.text}</div>
                <div class="msg-time">${data.time}</div>
            `;
            box.appendChild(div);
            box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
        }

        function openCreateModal() { document.getElementById('modal-group').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal-group').style.display = 'none'; }
        function confirmCreateGroup() {
            const name = document.getElementById('new-room-name').value.trim();
            if(name) { changeRoom(name); closeModal(); }
        }

        document.getElementById('msg-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMsg(); });
    </script>
</body>
</html>